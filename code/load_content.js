async function loadPythonCode(taskID,name){try{const response=await fetch(`assets/content/ex${taskID}/${name}.py`);if(!response.ok){throw new Error(`HTTP error! status: ${response.status}`);}
const code=await response.text();return code;}catch(error){console.error('Ошибка загрузки файла:',error);return'❌ Не удалось загрузить код ❌';}}
function jsonToTask(str){return str.replace(/\$br/g,'<br>').replace(/\$i(.*?)\$\/i/g,'<i>$1</i>').replace(/\$B(.*?)\$\/B/g,'<b>$1</b>').replace(/\$u(.*?)\$\/u/g,'<u>$1</u>').replace(/\$sb([a-zA-Z0-9.]+)/g,'<sub>$1</sub>').replace(/\$sp([a-zA-Z0-9.]+)/g,'<sup>$1</sup>').replace(/\$a(.*?)\$\/a/g,'<span class="attention">$1</span>')}
function jsonToCode(str){return str.replace(/\$L/g,'\n').replace(/\$Q/g,'"').split('$|')}
function createLegendElement(taskID,taskData){const legendElem=document.createElement('legend');const summary=document.createElement('h1');summary.className=`summary-heading ${taskData.legend?.tech?.join(' ') || ''}`;summary.textContent=`Номер ${taskID}`;legendElem.appendChild(summary);if(taskData.legend?.synopsis){const synopsis=document.createElement('p');synopsis.className='synopsis';synopsis.innerHTML=jsonToTask(taskData.legend.synopsis);legendElem.appendChild(synopsis);}
if(taskData.legend?.courses?.length>0){legendElem.appendChild(document.createTextNode('Уроки:'));const videos=document.createElement('div');videos.className='videos';taskData.legend.courses.forEach(course=>{if(course?.link){const link=document.createElement('a');link.href=`https://${course.link}`;link.target='_blank';link.textContent=course.comment;if(isMobile()){link.addEventListener('click',compressTableOfContents);}
const domain=course.link.split('/')[0];switch(domain){case"youtu.be":link.classList.add("yt");break;case"bobr.video":link.classList.add("bobr");break;}
videos.appendChild(link);}});legendElem.appendChild(videos);}
return legendElem;}
function createContentElement(item,taskID){try{let elem;switch(item.type){case'desc':elem=document.createElement('p');elem.className='desc';elem.innerHTML=`${item.inner}${item.link ? `<a href="https://${item.link}"target="_blank"><img src="assets/misc/up_right_arrow.svg"draggable="false"class="show-link"></a>` : ''}`;break;case'text':elem=document.createElement('p');elem.className='text';elem.innerHTML=jsonToTask(item.inner);break;case'task':elem=document.createElement('div');elem.className='task-text';elem.innerHTML=`${item.task ? `<a href="${item.link}"target="_blank"class="inline_link">№ ${item.task}.</a>` : ``}${jsonToTask(item.inner)}${item.table ? `<div class="table-wrap"><table><tr><th>?</th><th>?</th><th>?</th><th>?</th><th><i>F</i></th></tr><tr><td>${item.table[1][0]}</td><td>${item.table[1][1]}</td><td>${item.table[1][2]}</td><td>${item.table[1][3]}</td><td>${item.table[1][4]}</td></tr><tr><td>${item.table[2][0]}</td><td>${item.table[2][1]}</td><td>${item.table[2][2]}</td><td>${item.table[2][3]}</td><td>${item.table[2][4]}</td></tr></table></div>` : ``}`;break;case'code':elem=document.createElement('div');elem.className='code-container';const buttonsElem=document.createElement('div');buttonsElem.className='code-action-buttons';const showComments=document.createElement('div');showComments.className='code-show-comment';const spanShowComment=document.createElement('span');spanShowComment.className='span-show-comment';spanShowComment.textContent='Показать комментарии';const spanHideComment=document.createElement('span');spanHideComment.className='span-hide-comment';spanHideComment.textContent='Скрыть комментарии';showComments.appendChild(spanShowComment);showComments.appendChild(spanHideComment);showComments.addEventListener('click',commentToggle);buttonsElem.appendChild(showComments);const codeElement=document.createElement('pre');const codeContent=document.createElement('code');codeContent.className='python';const rawCode=jsonToCode(item.inner);const codeID=rawCode[0];const codeStr=rawCode[1];const linkGit=document.createElement('a');linkGit.className='code-link-git';linkGit.href=`https://github.com/Ultrad00d/ultrad00d.github.io/tree/main/assets/content/ex${taskID}/${codeID}.py`;linkGit.target='_blank';linkGit.textContent='Исходный код';buttonsElem.appendChild(linkGit);codeContent.textContent=codeStr;codeElement.appendChild(codeContent);elem.appendChild(codeElement);hljs.highlightElement(codeContent);hljs.lineNumbersBlock(codeContent);elem.appendChild(buttonsElem);break;case'hr':elem=document.createElement('hr');break;case'img':elem=document.createElement('div');elem.className='img-container';const img=document.createElement('img');img.src=item.inner;img.alt=item.alt||'';img.onload=function(){const isPortrait=this.naturalHeight>this.naturalWidth;if(isPortrait){elem.dataset.orientation="portrait";}else{elem.dataset.orientation="landscape";}};const sizes={'small':'img-small','medium':'img-medium','large':'img-large'};if(item.size&&sizes[item.size]){img.classList.add(sizes[item.size]);}else{img.classList.add(sizes['medium']);}
if(item.comment){elem.dataset.comment=item.comment;elem.classList.add('commented');}
if(item.filter){img.style.filter=item.filter;}
elem.appendChild(img);break;case'inline':elem=document.createElement('div');elem.className='inline-group';for(const groupItem of item.items){const childElem=createContentElement(groupItem,taskID);elem.appendChild(childElem);}
break;default:console.warn(`Неизвестный тип элемента: ${item.type}`);elem=document.createElement('div');elem.textContent=`[Неизвестный тип элемента: ${item.type}]`;}
return elem;}catch(error){console.error('Ошибка создания элемента:',error);const errorElem=document.createElement('div');errorElem.className='error';errorElem.textContent=`Ошибка при создании элемента: ${error.message}`;return errorElem;}}
async function createSectionElements(taskID,taskData){const summary=document.getElementById(`summary${taskID}`);const content=document.getElementById(`content${taskID}`);if(!summary||!content){console.error(`Не найдены элементы для задания ${taskID}`);return;}
const legendElem=createLegendElement(taskID,taskData);summary.appendChild(legendElem);summary.appendChild(document.createElement('hr'));const menuElem=document.createElement('menu');summary.appendChild(menuElem);for(const section of taskData.sections){const liElem=document.createElement('li');liElem.innerHTML=`<a href="#${section.id}">${section.name}</a>`;menuElem.appendChild(liElem);const sectionElem=document.createElement('section');sectionElem.id=section.id;for(const item of section.content){try{const elem=await createContentElement(item,taskID);sectionElem.appendChild(elem);}catch(error){console.error(`Ошибка обработки элемента:`,error);}}
content.appendChild(sectionElem);}}
function createContentContainer(taskID){const contentContainer=document.createElement('div');contentContainer.id=`content${taskID}`;contentContainer.className='content';return contentContainer}
function createSummaryContainer(taskID){const summaryContainer=document.createElement('ul');summaryContainer.id=`summary${taskID}`;summaryContainer.className='summary';return summaryContainer}
function createPageRadio(taskID){const pageRadio=document.createElement('label');const pageItem=document.createElement('span');const input=document.createElement('input');pageRadio.className='pageRadio';pageItem.className='page-item';pageItem.textContent=`Номер ${taskID == 19 ? `19-21` : taskID}`;input.type='radio';input.name='pageNumber';input.value=taskID;input.addEventListener('click',updateActiveClass);pageRadio.appendChild(pageItem);pageRadio.appendChild(input);return pageRadio}
function createTaskElements(taskID){const pageFrame=document.getElementById('page-frame');const summariesContainer=document.getElementById('summaries-container');pageFrame.appendChild(createContentContainer(taskID));summariesContainer.appendChild(createSummaryContainer(taskID));}
function createPagesSkeleton(avail){const pageFieldset=document.getElementById('pageFieldset');const mobilePagesContainer=document.getElementById('mobile-pages-container');avail.forEach(ex=>{const radio1=createPageRadio(ex);radio1.className='pageRadio loading';const radio2=createPageRadio(ex);radio2.className='pageRadio loading';pageFieldset.appendChild(radio1);mobilePagesContainer.appendChild(radio2);})}
function updatePageRadio(taskID,techs,index){const labels=document.querySelectorAll(`label.loading:has(input[value="${taskID}"])`);labels.forEach(label=>{setTimeout(()=>{label.className='pageRadio';techs.forEach(tech=>{label.classList.add(tech);})
label.classList.toggle('pop');setTimeout(()=>{label.classList.remove('pop');},300);},40*index);})}
async function loadJsonData(){try{const response=await fetch('assets/content/content.json.gz');if(!response.ok)throw new Error('Ошибка загрузки файла');const compressedData=await response.arrayBuffer();const jsonStr=pako.inflate(new Uint8Array(compressedData),{to:'string'});const data=JSON.parse(jsonStr);const appVersion=data.update.version;updateVersion(appVersion);sendVersionNotification(appVersion,data.update.changelog);createPagesSkeleton(data.available_ex);data.available_ex.forEach((taskID,index)=>{const taskData=data[taskID];createTaskElements(taskID);updatePageRadio(taskID,taskData.legend.tech,index);createSectionElements(taskID,taskData);});}catch(error){console.error('Ошибка загрузки данных:',error);}}
document.addEventListener('DOMContentLoaded',()=>{loadJsonData().catch(console.error);});